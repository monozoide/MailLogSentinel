.TH MAILLOGSENTINEL 8 "October 2025" "MailLogSentinel" "System Administration"

.SH NAME
maillogsentinel - monitor Postfix SASL authentication failures

.SH SYNOPSIS

.nf
.RS 4
maillogsentinel [options]
maillogsentinel --setup [--config FILE]

.RE
.fi
.SH DESCRIPTION
MailLogSentinel parses Postfix SASL authentication logs, records failed login attempts, and emails daily reports. The utility keeps persistent CSV and state files so subsequent runs only process new log lines. Normal operation must be executed as an unprivileged service user; root access is only required for the initial setup workflow.

The program reads configuration values from an INI file (see Configuration). When invoked without command options, it processes the configured mail log, updates the persistent dataset, and generates progress messages on stdout. Dedicated subcommands are available for reporting, state resets, SQL export/import, and non-interactive setup.

.SH OPTIONS

.TP
\fB--config FILE\fR
Override the default configuration file path (/etc/maillogsentinel.conf). When combined with --setup the supplied file is treated as the source template for automated provisioning.
.TP
\fB--setup\fR
Create or refresh configuration, directories, and systemd units. Run this command with root privileges. Without --config the setup wizard runs interactively and writes /etc/maillogsentinel.conf. When --config is supplied, the wizard performs an automated deployment using that template.
.TP
\fB--report\fR
Send the daily email summary immediately using the currently persisted dataset. Requires mail transport configuration in the config file.
.TP
\fB--reset\fR
Back up the CSV, operational log, and offset state into ~/maillogsentinel_backup_XXXXXX, then remove the originals so the next execution reprocesses all historical logs. Cron/systemd timers must be managed manually afterwards.
.TP
\fB--purge\fR
Perform the same archival workflow as --reset but is intended for complete environment refreshes. All persisted artefacts are moved into a timestamped directory beneath the invoking user's home.
.TP
\fB--sql-export\fR
Append newly discovered events to SQL files located in the configured sql_export_dir. Use this for long-term storage or downstream analytics systems that ingest SQL statements.
.TP
\fB--sql-import\fR
Read .sql files from sql_export_dir and replay them against the database described in the [database] section of the configuration.
.SH PREREQUISITES
.PP
Python 3.10 or later.

.PP
Access to the Postfix log files defined in the configuration.

.PP
A functional local mail transfer agent for dispatching summary emails.

.PP
Root privileges for the setup command; day-to-day execution should use a dedicated service account.

.SH CONFIGURATION
Settings are stored in an INI file (default /etc/maillogsentinel.conf). Only keys that persist between executions or affect operations are documented below. Developer-oriented tuning options are described in the project documentation.

.SS [paths]
.TP
\fBworking_dir\fR
Location for the persistent CSV (maillogsentinel.csv) and operational log (maillogsentinel.log). Ensure the service account can read and write this directory.
.TP
\fBstate_dir\fR
Directory containing state.offset, which tracks the last processed position within the mail log.
.TP
\fBmail_log\fR
Absolute path to the mail log file to monitor, typically /var/log/mail.log.
.SS [report]
.TP
\fBemail\fR
Recipient address for the daily summary email. The message body lists top sources, usernames, and other aggregated indicators derived from the CSV.
.SS [general]
.TP
\fBlog_level\fR
Logging verbosity for maillogsentinel.log. Accepts DEBUG, INFO, WARNING, ERROR, or CRITICAL.
.SS [dns_cache]
.TP
\fBenabled\fR
Toggle cached reverse DNS lookups to reduce latency and repeated resolver traffic.
.TP
\fBsize\fR
Maximum number of entries retained in the DNS cache.
.TP
\fBttl_seconds\fR
Expiration time for cached DNS entries.
.SS [ipinfo]
.TP
\fBcountry_db_path\fR
Path to the country database used for IP geolocation.
.TP
\fBasn_db_path\fR
Path to the ASN database used for enrichment.
.TP
\fBdb_update_url_country\fR
Download URL for refreshing the country database.
.TP
\fBdb_update_url_asn\fR
Download URL for refreshing the ASN database.
.SS [database]
.TP
\fBsql_export_dir\fR
Directory that stores generated SQL export files and the source material for --sql-import.
.TP
\fBdb_type\fR
Database backend used for imports (for example postgresql or mysql).
.TP
\fBdb_host\fR
Hostname or address of the database service.
.TP
\fBdb_name\fR
Target database schema.
.TP
\fBdb_user\fR
Credential name for database access.
.TP
\fBdb_password\fR
Password used by db_user. Protect this file with restrictive permissions.
.SH FILES
.TP
\fI/etc/maillogsentinel.conf\fR
Primary configuration file created by --setup.
.TP
\fI<working_dir>/maillogsentinel.csv\fR
Persistent datastore containing failed authentication events.
.TP
\fI<working_dir>/maillogsentinel.log\fR
Operational log capturing runtime diagnostics.
.TP
\fI<state_dir>/state.offset\fR
Offset tracker that prevents reprocessing of previously parsed log lines.
.TP
\fI<sql_export_dir>/*.sql\fR
Incremental SQL export batches generated by --sql-export.
.TP
\fI./maillogsentinel_setup.log\fR
Transcript of the last setup session, useful for troubleshooting provisioning issues.

.SH DIAGNOSTICS
Runtime messages are written to stdout and to maillogsentinel.log using the configured log level. When deployed as a systemd service, inspect progress with:

.nf
.RS 4
journalctl -u maillogsentinel.service
journalctl -u maillogsentinel-report.service

.RE
.fi
Failures during setup are documented in maillogsentinel_setup.log. SQL import/export issues are logged alongside the operational log file.

.SH SYSTEMD INTEGRATION
The setup wizard installs sample units named maillogsentinel.service, maillogsentinel-extract.timer, maillogsentinel-report.service, and maillogsentinel-report.timer. Review and adjust the User= directive and paths before copying them to /etc/systemd/system, then reload systemd and enable the timers.

.SH SECURITY
Do not run the main extraction workflow as root. Grant the service user read access to mail logs and write access to the working/state directories. Protect /etc/maillogsentinel.conf because it may contain SMTP credentials and database passwords.
Network downloads performed by ipinfo.py should be executed with appropriate firewalls and TLS validation in place.

.SH AUXILIARY UTILITIES
.TP
\fBbin/log_anonymizer.py\fR
Redacts sensitive fields within mail logs to support troubleshooting without leaking credentials or addresses.
.TP
\fBbin/ipinfo.py\fR
Maintains the geolocation databases referenced by [ipinfo] settings and can query IP metadata on demand. Use bin/ipinfo.py --update to refresh the datasets.

.SH EXAMPLES
Initial interactive deployment

.nf
.RS 4
sudo python3 maillogsentinel.py --setup

.RE
.fi
Automated deployment from a prepared configuration

.nf
.RS 4
sudo python3 maillogsentinel.py --config /opt/bootstrap/maillogsentinel.conf --setup

.RE
.fi
Daily processing from a custom configuration

.nf
.RS 4
python3 maillogsentinel.py --config /srv/maillogsentinel/maillogsentinel.conf

.RE
.fi
Force immediate email delivery for the accumulated dataset

.nf
.RS 4
python3 maillogsentinel.py --report

.RE
.fi
Archive existing state and restart ingestion

.nf
.RS 4
python3 maillogsentinel.py --reset

.RE
.fi
.SH EXIT STATUS
.TP
\fB0\fR
Successful execution.

.TP
\fB1\fR
A recoverable error occurred (for example missing configuration, permission errors, or setup cancellation). Inspect maillogsentinel.log or maillogsentinel_setup.log for details.

.SH REPORTING BUGS
Report issues at https://github.com/monozoide/MailLogSentinel/issues.

.SH AUTHOR
Written by monozoide. Project home page: https://github.com/monozoide/MailLogSentinel.

.SH SEE ALSO
\fBfail2ban(1)\fR

\fBjournalctl(1)\fR

\fBsystemd.service(5)\fR

\fBsystemd.timer(5)\fR

\fBrsyslog.conf(5)\fR

\fBsyslog-ng.conf(5)\fR